<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Raft Kv | fzdwx</title><meta name=keywords content="mit6.824"><meta name=description content="Lab2æ–‡æ¡£ç¿»è¯‘ Introduction è¿™æ˜¯ä¸€ç³»åˆ—å®éªŒä¸­çš„ç¬¬ä¸€ä¸ªï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªfault-tolerant key/value storage systemã€‚ åœ¨æœ¬å®éªŒä¸­æˆ‘ä»¬å°†å®ç°Raft(ä¸€ç§å¤åˆ¶çš„çŠ¶æ€æœºåè®®)ã€‚åœ¨ä¸‹ä¸€ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬å°†åœ¨Raftä¸Šæ„å»ºä¸€ä¸ªkey/value serviceã€‚ ç„¶åï¼Œæ‚¨å°†åœ¨å¤šä¸ªå¤åˆ¶çš„çŠ¶æ€æœºä¸Šè¿›è¡Œshardæ¥æé«˜æ€§èƒ½ã€‚
å¤åˆ¶çš„æœåŠ¡é€šè¿‡åœ¨å¤šä¸ªå¤åˆ¶æœåŠ¡å™¨ä¸Šå­˜å‚¨å…¶çŠ¶æ€(å³æ•°æ®)çš„å®Œæ•´å‰¯æœ¬æ¥å®ç°fault toleranceã€‚ å³ä½¿æœ‰ä¸€äº›æœåŠ¡å™¨å‡ºç°æ•…éšœ(å´©æºƒæˆ–ç½‘ç»œæ–­å¼€å’ŒæŠ–åŠ¨)replicationä¹Ÿå…è®¸å®ƒä»¬ç»§ç»­è¿è¡Œã€‚ æŒ‘æˆ˜åœ¨äºfailureså¯èƒ½å¯¼è‡´å‰¯æœ¬å­˜åœ¨ä¸åŒçš„æ•°æ®ã€‚
Raftå°†å®¢æˆ·ç«¯çš„è¯·æ±‚ç»„ç»‡æˆä¸€ä¸ªåºåˆ—ï¼Œè¢«æˆä¸ºlogï¼Œå¹¶ä¸”ç¡®ä¿æ‰€æœ‰replica serversçœ‹åˆ°ç›¸åŒçš„logã€‚ æ¯ä¸ªå‰¯æœ¬æŒ‰ç…§æ—¥å¿—çš„é¡ºåºæ¥æ‰§è¡Œå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå°†å®ƒä»¬åº”ç”¨äºå…¶æœ¬åœ°çš„æœåŠ¡çŠ¶æ€å‰¯æœ¬ã€‚ ç”±äºæ‰€æœ‰å­˜æ´»çš„å‰¯æœ¬è¯»å–çš„æ—¥å¿—å†…å®¹éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥éƒ½ä»¥ç›¸åŒçš„é¡ºåºæ¥æ‰§è¡Œè¯·æ±‚ï¼Œå› æ­¤å®ƒä»¬éƒ½æœ‰ç›¸åŒçš„æœåŠ¡çŠ¶æ€ã€‚ å¦‚æœä¸€ä¸ªæœåŠ¡å™¨å¤±è´¥äº†ä½†æ˜¯åæ¥åˆæ¢å¤æ¥ï¼ŒRaftä¼šå¤åˆ¶æŠŠå®ƒçš„æ—¥å¿—æ›´æ–°ã€‚åªè¦è‡³å°‘å¤§å¤šæ•°çš„æœåŠ¡å™¨è¿˜æˆ–è€…ï¼Œå¹¶ä¸”èƒ½å¤Ÿç»§ç»­é€šä¿¡ï¼Œ é‚£ä¹ˆRaftå°†ç»§ç»­è¿è¡Œã€‚å¦‚æœæ²¡æœ‰åˆ°è¾¾è¿™ä¸ªæ•°é‡ï¼Œé‚£ä¹ˆRaftå°†ä¼šåœæ­¢è¿è¡Œï¼Œç›´åˆ°åˆ°è¾¾è¿™ä¸ªæ•°é‡æ‰ä¼šé‡æ–°å¼€å§‹ã€‚
åœ¨æœ¬labä¸­ï¼Œä½ å°†æŠŠRaftå®ç°ä¸ºä¸€ä¸ªå¸¦æœ‰ç›¸å…³æ–¹æ³•çš„GOçš„å¯¹è±¡ç±»å‹ï¼Œç›®çš„æ˜¯ä¸ºäº†èƒ½åœ¨æ›´å¤§çš„æ¨¡å—ä¸­ä½¿ç”¨ã€‚ ä¸€ç»„Raftå®ä¾‹é€šè¿‡RPCæ¥ç»´æŠ¤replicated logsã€‚ä½ çš„Raftå®ä¾‹å°†æ”¯æŒä¸€è¿ä¸²ä¸ç¡®å®šç¼–å·(æ•°é‡?)çš„commandï¼Œ ä¹Ÿå¯ä»¥å«log entriesã€‚ è¿™äº›entriesé€šè¿‡ç´¢å¼•æ¥è¿›è¡Œç¼–å·ã€‚å…·æœ‰ç»™å®šç´¢å¼•çš„log entryå°†è¢«æäº¤ï¼Œæ­¤æ—¶ï¼Œ æ‚¨çš„Raftåº”è¯¥å°†è¿™ä¸ªæ¡logå‘é€åˆ°æ›´å¤§çš„æœåŠ¡ä¸Šæ‰§è¡Œã€‚
ä½ åº”è¯¥éµå¾ª extended Raft paper ä¸­è®¾è®¡ï¼Œ ç‰¹åˆ«æ˜¯å›¾ 2.ä½ å°†å®ç°è®ºæ–‡å®çš„å¤§ éƒ¨åˆ†å†…å®¹ï¼ŒåŒ…æ‹¬ä¿å­˜æŒä¹…åŒ–çŠ¶æ€å’ŒèŠ‚ç‚¹æ•…éšœè‡ªåŠ¨é‡å¯åè¯»å–çŠ¶æ€ã€‚ ä½ å°†ä¸ä¼šå®ç°é›†ç¾¤æˆå‘˜çš„å˜åŒ–(Section 6)ã€‚
ä½ å¯èƒ½ä¼šå‘ç°è¿™ä¸ª æŒ‡å— å¾ˆæœ‰ç”¨ï¼Œ è¿˜æœ‰è¿™ä¸ªå…³äºconcurrencyçš„é” å’Œç»“æ„ çš„å»ºè®®ï¼Œ å¦‚æœéœ€è¦æ›´å¹¿æ³›çš„è§†è§’ï¼Œå¯ä»¥çœ‹çœ‹Paxos, Chubby, Paxos Made Live, Spanner, Zookeeper, Harp, Viewstamped Replicationå’Œ Bolosky et al ã€‚
è¯·è®°ä½ï¼Œæœ¬ lab ä¸­æœ€å…·æŒ‘æˆ˜æ€§çš„éƒ¨åˆ†å¯èƒ½ä¸æ˜¯å®ç°ä½ çš„è§£å†³æ–¹æ¡ˆï¼Œè€Œæ˜¯è°ƒè¯•å®ƒã€‚ä¸ºäº†å¸®åŠ©åº”å¯¹è¿™ä¸€æŒ‘æˆ˜ï¼Œä½ å¯èƒ½éœ€è¦æŠŠäº‹ä»¶èŠ±åœ¨å¦‚ä½•ä½¿ä½ çš„å®ç°æ›´å®¹æ˜“è°ƒè¯•ã€‚ ä½ å¯ä»¥å‚è€ƒ æŒ‡å¯¼é¡µ å’Œè¿™ç¯‡å…³äºæœ‰æ•ˆæ‰“å°å£°æ˜çš„ åšæ–‡ ã€‚
æˆ‘ä»¬è¿˜æä¾›äº† Raft äº¤äº’å›¾ ï¼Œ å¯ä»¥å¸®åŠ©é˜æ˜Raftä»£ç å¦‚ä½•ä¸ä¸Šå±‚(ä½¿ç”¨è€…?)äº¤äº’ã€‚"><meta name=author content="fzdwx"><link rel=canonical href=https://fzdwx.github.io/posts/2022-10-10-raftkv/><link crossorigin=anonymous href=/assets/css/stylesheet.min.f4ba9e91d82641c0782cb9993a10fc48243527ef01b5ff5a848898b2ff630ad2.css integrity="sha256-9LqekdgmQcB4LLmZOhD8SCQ1J+8Btf9ahIiYsv9jCtI=" rel="preload stylesheet" as=style><link rel=icon href=https://fzdwx.github.io/favicon.ico><link rel=apple-touch-icon href=https://fzdwx.github.io/apple-touch-icon.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-DGKZ9K6GHW"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DGKZ9K6GHW",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary"><meta name=twitter:title content="Raft Kv | fzdwx"><meta name=twitter:description content="Lab2æ–‡æ¡£ç¿»è¯‘ Introduction è¿™æ˜¯ä¸€ç³»åˆ—å®éªŒä¸­çš„ç¬¬ä¸€ä¸ªï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªfault-tolerant key/value storage systemã€‚ åœ¨æœ¬å®éªŒä¸­æˆ‘ä»¬å°†å®ç°Raft(ä¸€ç§å¤åˆ¶çš„çŠ¶æ€æœºåè®®)ã€‚åœ¨ä¸‹ä¸€ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬å°†åœ¨Raftä¸Šæ„å»ºä¸€ä¸ªkey/value serviceã€‚ ç„¶åï¼Œæ‚¨å°†åœ¨å¤šä¸ªå¤åˆ¶çš„çŠ¶æ€æœºä¸Šè¿›è¡Œshardæ¥æé«˜æ€§èƒ½ã€‚
å¤åˆ¶çš„æœåŠ¡é€šè¿‡åœ¨å¤šä¸ªå¤åˆ¶æœåŠ¡å™¨ä¸Šå­˜å‚¨å…¶çŠ¶æ€(å³æ•°æ®)çš„å®Œæ•´å‰¯æœ¬æ¥å®ç°fault toleranceã€‚ å³ä½¿æœ‰ä¸€äº›æœåŠ¡å™¨å‡ºç°æ•…éšœ(å´©æºƒæˆ–ç½‘ç»œæ–­å¼€å’ŒæŠ–åŠ¨)replicationä¹Ÿå…è®¸å®ƒä»¬ç»§ç»­è¿è¡Œã€‚ æŒ‘æˆ˜åœ¨äºfailureså¯èƒ½å¯¼è‡´å‰¯æœ¬å­˜åœ¨ä¸åŒçš„æ•°æ®ã€‚
Raftå°†å®¢æˆ·ç«¯çš„è¯·æ±‚ç»„ç»‡æˆä¸€ä¸ªåºåˆ—ï¼Œè¢«æˆä¸ºlogï¼Œå¹¶ä¸”ç¡®ä¿æ‰€æœ‰replica serversçœ‹åˆ°ç›¸åŒçš„logã€‚ æ¯ä¸ªå‰¯æœ¬æŒ‰ç…§æ—¥å¿—çš„é¡ºåºæ¥æ‰§è¡Œå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå°†å®ƒä»¬åº”ç”¨äºå…¶æœ¬åœ°çš„æœåŠ¡çŠ¶æ€å‰¯æœ¬ã€‚ ç”±äºæ‰€æœ‰å­˜æ´»çš„å‰¯æœ¬è¯»å–çš„æ—¥å¿—å†…å®¹éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥éƒ½ä»¥ç›¸åŒçš„é¡ºåºæ¥æ‰§è¡Œè¯·æ±‚ï¼Œå› æ­¤å®ƒä»¬éƒ½æœ‰ç›¸åŒçš„æœåŠ¡çŠ¶æ€ã€‚ å¦‚æœä¸€ä¸ªæœåŠ¡å™¨å¤±è´¥äº†ä½†æ˜¯åæ¥åˆæ¢å¤æ¥ï¼ŒRaftä¼šå¤åˆ¶æŠŠå®ƒçš„æ—¥å¿—æ›´æ–°ã€‚åªè¦è‡³å°‘å¤§å¤šæ•°çš„æœåŠ¡å™¨è¿˜æˆ–è€…ï¼Œå¹¶ä¸”èƒ½å¤Ÿç»§ç»­é€šä¿¡ï¼Œ é‚£ä¹ˆRaftå°†ç»§ç»­è¿è¡Œã€‚å¦‚æœæ²¡æœ‰åˆ°è¾¾è¿™ä¸ªæ•°é‡ï¼Œé‚£ä¹ˆRaftå°†ä¼šåœæ­¢è¿è¡Œï¼Œç›´åˆ°åˆ°è¾¾è¿™ä¸ªæ•°é‡æ‰ä¼šé‡æ–°å¼€å§‹ã€‚
åœ¨æœ¬labä¸­ï¼Œä½ å°†æŠŠRaftå®ç°ä¸ºä¸€ä¸ªå¸¦æœ‰ç›¸å…³æ–¹æ³•çš„GOçš„å¯¹è±¡ç±»å‹ï¼Œç›®çš„æ˜¯ä¸ºäº†èƒ½åœ¨æ›´å¤§çš„æ¨¡å—ä¸­ä½¿ç”¨ã€‚ ä¸€ç»„Raftå®ä¾‹é€šè¿‡RPCæ¥ç»´æŠ¤replicated logsã€‚ä½ çš„Raftå®ä¾‹å°†æ”¯æŒä¸€è¿ä¸²ä¸ç¡®å®šç¼–å·(æ•°é‡?)çš„commandï¼Œ ä¹Ÿå¯ä»¥å«log entriesã€‚ è¿™äº›entriesé€šè¿‡ç´¢å¼•æ¥è¿›è¡Œç¼–å·ã€‚å…·æœ‰ç»™å®šç´¢å¼•çš„log entryå°†è¢«æäº¤ï¼Œæ­¤æ—¶ï¼Œ æ‚¨çš„Raftåº”è¯¥å°†è¿™ä¸ªæ¡logå‘é€åˆ°æ›´å¤§çš„æœåŠ¡ä¸Šæ‰§è¡Œã€‚
ä½ åº”è¯¥éµå¾ª extended Raft paper ä¸­è®¾è®¡ï¼Œ ç‰¹åˆ«æ˜¯å›¾ 2.ä½ å°†å®ç°è®ºæ–‡å®çš„å¤§ éƒ¨åˆ†å†…å®¹ï¼ŒåŒ…æ‹¬ä¿å­˜æŒä¹…åŒ–çŠ¶æ€å’ŒèŠ‚ç‚¹æ•…éšœè‡ªåŠ¨é‡å¯åè¯»å–çŠ¶æ€ã€‚ ä½ å°†ä¸ä¼šå®ç°é›†ç¾¤æˆå‘˜çš„å˜åŒ–(Section 6)ã€‚
ä½ å¯èƒ½ä¼šå‘ç°è¿™ä¸ª æŒ‡å— å¾ˆæœ‰ç”¨ï¼Œ è¿˜æœ‰è¿™ä¸ªå…³äºconcurrencyçš„é” å’Œç»“æ„ çš„å»ºè®®ï¼Œ å¦‚æœéœ€è¦æ›´å¹¿æ³›çš„è§†è§’ï¼Œå¯ä»¥çœ‹çœ‹Paxos, Chubby, Paxos Made Live, Spanner, Zookeeper, Harp, Viewstamped Replicationå’Œ Bolosky et al ã€‚
è¯·è®°ä½ï¼Œæœ¬ lab ä¸­æœ€å…·æŒ‘æˆ˜æ€§çš„éƒ¨åˆ†å¯èƒ½ä¸æ˜¯å®ç°ä½ çš„è§£å†³æ–¹æ¡ˆï¼Œè€Œæ˜¯è°ƒè¯•å®ƒã€‚ä¸ºäº†å¸®åŠ©åº”å¯¹è¿™ä¸€æŒ‘æˆ˜ï¼Œä½ å¯èƒ½éœ€è¦æŠŠäº‹ä»¶èŠ±åœ¨å¦‚ä½•ä½¿ä½ çš„å®ç°æ›´å®¹æ˜“è°ƒè¯•ã€‚ ä½ å¯ä»¥å‚è€ƒ æŒ‡å¯¼é¡µ å’Œè¿™ç¯‡å…³äºæœ‰æ•ˆæ‰“å°å£°æ˜çš„ åšæ–‡ ã€‚
æˆ‘ä»¬è¿˜æä¾›äº† Raft äº¤äº’å›¾ ï¼Œ å¯ä»¥å¸®åŠ©é˜æ˜Raftä»£ç å¦‚ä½•ä¸ä¸Šå±‚(ä½¿ç”¨è€…?)äº¤äº’ã€‚"><meta property="og:title" content="Raft Kv | fzdwx"><meta property="og:description" content="Lab2æ–‡æ¡£ç¿»è¯‘ Introduction è¿™æ˜¯ä¸€ç³»åˆ—å®éªŒä¸­çš„ç¬¬ä¸€ä¸ªï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªfault-tolerant key/value storage systemã€‚ åœ¨æœ¬å®éªŒä¸­æˆ‘ä»¬å°†å®ç°Raft(ä¸€ç§å¤åˆ¶çš„çŠ¶æ€æœºåè®®)ã€‚åœ¨ä¸‹ä¸€ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬å°†åœ¨Raftä¸Šæ„å»ºä¸€ä¸ªkey/value serviceã€‚ ç„¶åï¼Œæ‚¨å°†åœ¨å¤šä¸ªå¤åˆ¶çš„çŠ¶æ€æœºä¸Šè¿›è¡Œshardæ¥æé«˜æ€§èƒ½ã€‚
å¤åˆ¶çš„æœåŠ¡é€šè¿‡åœ¨å¤šä¸ªå¤åˆ¶æœåŠ¡å™¨ä¸Šå­˜å‚¨å…¶çŠ¶æ€(å³æ•°æ®)çš„å®Œæ•´å‰¯æœ¬æ¥å®ç°fault toleranceã€‚ å³ä½¿æœ‰ä¸€äº›æœåŠ¡å™¨å‡ºç°æ•…éšœ(å´©æºƒæˆ–ç½‘ç»œæ–­å¼€å’ŒæŠ–åŠ¨)replicationä¹Ÿå…è®¸å®ƒä»¬ç»§ç»­è¿è¡Œã€‚ æŒ‘æˆ˜åœ¨äºfailureså¯èƒ½å¯¼è‡´å‰¯æœ¬å­˜åœ¨ä¸åŒçš„æ•°æ®ã€‚
Raftå°†å®¢æˆ·ç«¯çš„è¯·æ±‚ç»„ç»‡æˆä¸€ä¸ªåºåˆ—ï¼Œè¢«æˆä¸ºlogï¼Œå¹¶ä¸”ç¡®ä¿æ‰€æœ‰replica serversçœ‹åˆ°ç›¸åŒçš„logã€‚ æ¯ä¸ªå‰¯æœ¬æŒ‰ç…§æ—¥å¿—çš„é¡ºåºæ¥æ‰§è¡Œå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå°†å®ƒä»¬åº”ç”¨äºå…¶æœ¬åœ°çš„æœåŠ¡çŠ¶æ€å‰¯æœ¬ã€‚ ç”±äºæ‰€æœ‰å­˜æ´»çš„å‰¯æœ¬è¯»å–çš„æ—¥å¿—å†…å®¹éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥éƒ½ä»¥ç›¸åŒçš„é¡ºåºæ¥æ‰§è¡Œè¯·æ±‚ï¼Œå› æ­¤å®ƒä»¬éƒ½æœ‰ç›¸åŒçš„æœåŠ¡çŠ¶æ€ã€‚ å¦‚æœä¸€ä¸ªæœåŠ¡å™¨å¤±è´¥äº†ä½†æ˜¯åæ¥åˆæ¢å¤æ¥ï¼ŒRaftä¼šå¤åˆ¶æŠŠå®ƒçš„æ—¥å¿—æ›´æ–°ã€‚åªè¦è‡³å°‘å¤§å¤šæ•°çš„æœåŠ¡å™¨è¿˜æˆ–è€…ï¼Œå¹¶ä¸”èƒ½å¤Ÿç»§ç»­é€šä¿¡ï¼Œ é‚£ä¹ˆRaftå°†ç»§ç»­è¿è¡Œã€‚å¦‚æœæ²¡æœ‰åˆ°è¾¾è¿™ä¸ªæ•°é‡ï¼Œé‚£ä¹ˆRaftå°†ä¼šåœæ­¢è¿è¡Œï¼Œç›´åˆ°åˆ°è¾¾è¿™ä¸ªæ•°é‡æ‰ä¼šé‡æ–°å¼€å§‹ã€‚
åœ¨æœ¬labä¸­ï¼Œä½ å°†æŠŠRaftå®ç°ä¸ºä¸€ä¸ªå¸¦æœ‰ç›¸å…³æ–¹æ³•çš„GOçš„å¯¹è±¡ç±»å‹ï¼Œç›®çš„æ˜¯ä¸ºäº†èƒ½åœ¨æ›´å¤§çš„æ¨¡å—ä¸­ä½¿ç”¨ã€‚ ä¸€ç»„Raftå®ä¾‹é€šè¿‡RPCæ¥ç»´æŠ¤replicated logsã€‚ä½ çš„Raftå®ä¾‹å°†æ”¯æŒä¸€è¿ä¸²ä¸ç¡®å®šç¼–å·(æ•°é‡?)çš„commandï¼Œ ä¹Ÿå¯ä»¥å«log entriesã€‚ è¿™äº›entriesé€šè¿‡ç´¢å¼•æ¥è¿›è¡Œç¼–å·ã€‚å…·æœ‰ç»™å®šç´¢å¼•çš„log entryå°†è¢«æäº¤ï¼Œæ­¤æ—¶ï¼Œ æ‚¨çš„Raftåº”è¯¥å°†è¿™ä¸ªæ¡logå‘é€åˆ°æ›´å¤§çš„æœåŠ¡ä¸Šæ‰§è¡Œã€‚
ä½ åº”è¯¥éµå¾ª extended Raft paper ä¸­è®¾è®¡ï¼Œ ç‰¹åˆ«æ˜¯å›¾ 2.ä½ å°†å®ç°è®ºæ–‡å®çš„å¤§ éƒ¨åˆ†å†…å®¹ï¼ŒåŒ…æ‹¬ä¿å­˜æŒä¹…åŒ–çŠ¶æ€å’ŒèŠ‚ç‚¹æ•…éšœè‡ªåŠ¨é‡å¯åè¯»å–çŠ¶æ€ã€‚ ä½ å°†ä¸ä¼šå®ç°é›†ç¾¤æˆå‘˜çš„å˜åŒ–(Section 6)ã€‚
ä½ å¯èƒ½ä¼šå‘ç°è¿™ä¸ª æŒ‡å— å¾ˆæœ‰ç”¨ï¼Œ è¿˜æœ‰è¿™ä¸ªå…³äºconcurrencyçš„é” å’Œç»“æ„ çš„å»ºè®®ï¼Œ å¦‚æœéœ€è¦æ›´å¹¿æ³›çš„è§†è§’ï¼Œå¯ä»¥çœ‹çœ‹Paxos, Chubby, Paxos Made Live, Spanner, Zookeeper, Harp, Viewstamped Replicationå’Œ Bolosky et al ã€‚
è¯·è®°ä½ï¼Œæœ¬ lab ä¸­æœ€å…·æŒ‘æˆ˜æ€§çš„éƒ¨åˆ†å¯èƒ½ä¸æ˜¯å®ç°ä½ çš„è§£å†³æ–¹æ¡ˆï¼Œè€Œæ˜¯è°ƒè¯•å®ƒã€‚ä¸ºäº†å¸®åŠ©åº”å¯¹è¿™ä¸€æŒ‘æˆ˜ï¼Œä½ å¯èƒ½éœ€è¦æŠŠäº‹ä»¶èŠ±åœ¨å¦‚ä½•ä½¿ä½ çš„å®ç°æ›´å®¹æ˜“è°ƒè¯•ã€‚ ä½ å¯ä»¥å‚è€ƒ æŒ‡å¯¼é¡µ å’Œè¿™ç¯‡å…³äºæœ‰æ•ˆæ‰“å°å£°æ˜çš„ åšæ–‡ ã€‚
æˆ‘ä»¬è¿˜æä¾›äº† Raft äº¤äº’å›¾ ï¼Œ å¯ä»¥å¸®åŠ©é˜æ˜Raftä»£ç å¦‚ä½•ä¸ä¸Šå±‚(ä½¿ç”¨è€…?)äº¤äº’ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://fzdwx.github.io/posts/2022-10-10-raftkv/"><meta property="og:image" content="https://avatars.githubusercontent.com/u/65269574?v=4"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-10T22:26:55+08:00"><meta property="article:modified_time" content="2022-10-10T22:26:55+08:00"><meta property="og:site_name" content="fzdwx"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://fzdwx.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Raft Kv","item":"https://fzdwx.github.io/posts/2022-10-10-raftkv/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Raft Kv | fzdwx","name":"Raft Kv","description":"Lab2æ–‡æ¡£ç¿»è¯‘ Introduction è¿™æ˜¯ä¸€ç³»åˆ—å®éªŒä¸­çš„ç¬¬ä¸€ä¸ªï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªfault-tolerant key/value storage systemã€‚ åœ¨æœ¬å®éªŒä¸­æˆ‘ä»¬å°†å®ç°Raft(ä¸€ç§å¤åˆ¶çš„çŠ¶æ€æœºåè®®)ã€‚åœ¨ä¸‹ä¸€ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬å°†åœ¨Raftä¸Šæ„å»ºä¸€ä¸ªkey/value serviceã€‚ ç„¶åï¼Œæ‚¨å°†åœ¨å¤šä¸ªå¤åˆ¶çš„çŠ¶æ€æœºä¸Šè¿›è¡Œshardæ¥æé«˜æ€§èƒ½ã€‚\nå¤åˆ¶çš„æœåŠ¡é€šè¿‡åœ¨å¤šä¸ªå¤åˆ¶æœåŠ¡å™¨ä¸Šå­˜å‚¨å…¶çŠ¶æ€(å³æ•°æ®)çš„å®Œæ•´å‰¯æœ¬æ¥å®ç°fault toleranceã€‚ å³ä½¿æœ‰ä¸€äº›æœåŠ¡å™¨å‡ºç°æ•…éšœ(å´©æºƒæˆ–ç½‘ç»œæ–­å¼€å’ŒæŠ–åŠ¨)replicationä¹Ÿå…è®¸å®ƒä»¬ç»§ç»­è¿è¡Œã€‚ æŒ‘æˆ˜åœ¨äºfailureså¯èƒ½å¯¼è‡´å‰¯æœ¬å­˜åœ¨ä¸åŒçš„æ•°æ®ã€‚\nRaftå°†å®¢æˆ·ç«¯çš„è¯·æ±‚ç»„ç»‡æˆä¸€ä¸ªåºåˆ—ï¼Œè¢«æˆä¸ºlogï¼Œå¹¶ä¸”ç¡®ä¿æ‰€æœ‰replica serversçœ‹åˆ°ç›¸åŒçš„logã€‚ æ¯ä¸ªå‰¯æœ¬æŒ‰ç…§æ—¥å¿—çš„é¡ºåºæ¥æ‰§è¡Œå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå°†å®ƒä»¬åº”ç”¨äºå…¶æœ¬åœ°çš„æœåŠ¡çŠ¶æ€å‰¯æœ¬ã€‚ ç”±äºæ‰€æœ‰å­˜æ´»çš„å‰¯æœ¬è¯»å–çš„æ—¥å¿—å†…å®¹éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥éƒ½ä»¥ç›¸åŒçš„é¡ºåºæ¥æ‰§è¡Œè¯·æ±‚ï¼Œå› æ­¤å®ƒä»¬éƒ½æœ‰ç›¸åŒçš„æœåŠ¡çŠ¶æ€ã€‚ å¦‚æœä¸€ä¸ªæœåŠ¡å™¨å¤±è´¥äº†ä½†æ˜¯åæ¥åˆæ¢å¤æ¥ï¼ŒRaftä¼šå¤åˆ¶æŠŠå®ƒçš„æ—¥å¿—æ›´æ–°ã€‚åªè¦è‡³å°‘å¤§å¤šæ•°çš„æœåŠ¡å™¨è¿˜æˆ–è€…ï¼Œå¹¶ä¸”èƒ½å¤Ÿç»§ç»­é€šä¿¡ï¼Œ é‚£ä¹ˆRaftå°†ç»§ç»­è¿è¡Œã€‚å¦‚æœæ²¡æœ‰åˆ°è¾¾è¿™ä¸ªæ•°é‡ï¼Œé‚£ä¹ˆRaftå°†ä¼šåœæ­¢è¿è¡Œï¼Œç›´åˆ°åˆ°è¾¾è¿™ä¸ªæ•°é‡æ‰ä¼šé‡æ–°å¼€å§‹ã€‚\nåœ¨æœ¬labä¸­ï¼Œä½ å°†æŠŠRaftå®ç°ä¸ºä¸€ä¸ªå¸¦æœ‰ç›¸å…³æ–¹æ³•çš„GOçš„å¯¹è±¡ç±»å‹ï¼Œç›®çš„æ˜¯ä¸ºäº†èƒ½åœ¨æ›´å¤§çš„æ¨¡å—ä¸­ä½¿ç”¨ã€‚ ä¸€ç»„Raftå®ä¾‹é€šè¿‡RPCæ¥ç»´æŠ¤replicated logsã€‚ä½ çš„Raftå®ä¾‹å°†æ”¯æŒä¸€è¿ä¸²ä¸ç¡®å®šç¼–å·(æ•°é‡?)çš„commandï¼Œ ä¹Ÿå¯ä»¥å«log entriesã€‚ è¿™äº›entriesé€šè¿‡ç´¢å¼•æ¥è¿›è¡Œç¼–å·ã€‚å…·æœ‰ç»™å®šç´¢å¼•çš„log entryå°†è¢«æäº¤ï¼Œæ­¤æ—¶ï¼Œ æ‚¨çš„Raftåº”è¯¥å°†è¿™ä¸ªæ¡logå‘é€åˆ°æ›´å¤§çš„æœåŠ¡ä¸Šæ‰§è¡Œã€‚\nä½ åº”è¯¥éµå¾ª extended Raft paper ä¸­è®¾è®¡ï¼Œ ç‰¹åˆ«æ˜¯å›¾ 2.ä½ å°†å®ç°è®ºæ–‡å®çš„å¤§ éƒ¨åˆ†å†…å®¹ï¼ŒåŒ…æ‹¬ä¿å­˜æŒä¹…åŒ–çŠ¶æ€å’ŒèŠ‚ç‚¹æ•…éšœè‡ªåŠ¨é‡å¯åè¯»å–çŠ¶æ€ã€‚ ä½ å°†ä¸ä¼šå®ç°é›†ç¾¤æˆå‘˜çš„å˜åŒ–(Section 6)ã€‚\nä½ å¯èƒ½ä¼šå‘ç°è¿™ä¸ª æŒ‡å— å¾ˆæœ‰ç”¨ï¼Œ è¿˜æœ‰è¿™ä¸ªå…³äºconcurrencyçš„é” å’Œç»“æ„ çš„å»ºè®®ï¼Œ å¦‚æœéœ€è¦æ›´å¹¿æ³›çš„è§†è§’ï¼Œå¯ä»¥çœ‹çœ‹Paxos, Chubby, Paxos Made Live, Spanner, Zookeeper, Harp, Viewstamped Replicationå’Œ Bolosky et al ã€‚\nè¯·è®°ä½ï¼Œæœ¬ lab ä¸­æœ€å…·æŒ‘æˆ˜æ€§çš„éƒ¨åˆ†å¯èƒ½ä¸æ˜¯å®ç°ä½ çš„è§£å†³æ–¹æ¡ˆï¼Œè€Œæ˜¯è°ƒè¯•å®ƒã€‚ä¸ºäº†å¸®åŠ©åº”å¯¹è¿™ä¸€æŒ‘æˆ˜ï¼Œä½ å¯èƒ½éœ€è¦æŠŠäº‹ä»¶èŠ±åœ¨å¦‚ä½•ä½¿ä½ çš„å®ç°æ›´å®¹æ˜“è°ƒè¯•ã€‚ ä½ å¯ä»¥å‚è€ƒ æŒ‡å¯¼é¡µ å’Œè¿™ç¯‡å…³äºæœ‰æ•ˆæ‰“å°å£°æ˜çš„ åšæ–‡ ã€‚\næˆ‘ä»¬è¿˜æä¾›äº† Raft äº¤äº’å›¾ ï¼Œ å¯ä»¥å¸®åŠ©é˜æ˜Raftä»£ç å¦‚ä½•ä¸ä¸Šå±‚(ä½¿ç”¨è€…?)äº¤äº’ã€‚","keywords":["mit6.824"],"wordCount":"1121","inLanguage":"en","datePublished":"2022-10-10T22:26:55+08:00","dateModified":"2022-10-10T22:26:55+08:00","author":{"@type":"Person","name":"fzdwx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fzdwx.github.io/posts/2022-10-10-raftkv/"},"publisher":{"@type":"Organization","name":"fzdwx","logo":{"@type":"ImageObject","url":"https://fzdwx.github.io/favicon.ico"}}}</script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark"),document.body.classList.add("light");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches?document.body.classList.add("dark"):document.body.classList.add("light")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="auto",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><script src=https://cdn.jsdelivr.net/npm/lucide@0.91.0/dist/cjs/lucide.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fontsource/jetbrains-mono@4.5.11/400.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fontsource/jetbrains-mono@4.5.11/400-italic.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fontsource/jetbrains-mono@4.5.11/500.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fontsource/jetbrains-mono@4.5.11/500-italic.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fontsource/jetbrains-mono@4.5.11/700.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fontsource/jetbrains-mono@4.5.11/800.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fontsource/jetbrains-mono@4.5.11/700-italic.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fontsource/jetbrains-mono@4.5.11/800-italic.css><header class=header><nav class=nav><div class=logo><a href=https://fzdwx.github.io/ accesskey=h title="fzdwx (Alt + H)">fzdwx</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://fzdwx.github.io/archives/ title=Archives>Archives</a></li><li><a href=https://fzdwx.github.io/tags/ title=Tags>Tags</a></li><li><a href=https://fzdwx.github.io/links/ title=Links>Links</a></li><li><a href=https://fzdwx.github.io/search/ title=ğŸ”>ğŸ”</a></li><li><a href=https://fzdwx.github.io/startpage/ title=ğŸ§¬>ğŸ§¬</a></li></ul></nav></header><div class=padding-header></div><main class="main post"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fzdwx.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://fzdwx.github.io/posts/>Posts</a></div><h1 class=post-title>Raft Kv</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>&nbsp;2022-10-10</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select:text"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" style="user-select:text"/><line x1="7" y1="7" x2="7" y2="7" style="user-select:text"/></svg>
<span class=post-tags><a href=https://fzdwx.github.io/tags/mit6.824/>mit6.824</a></span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg>
<span>1121 words</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>6 min</span></span></div></header><div class="toc side right"><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#lab2%e6%96%87%e6%a1%a3%e7%bf%bb%e8%af%91 aria-label=Lab2æ–‡æ¡£ç¿»è¯‘>Lab2æ–‡æ¡£ç¿»è¯‘</a><ul><li><a href=#introduction aria-label=Introduction>Introduction</a></li><li><a href=#the-code aria-label="The code">The code</a><ul><li><a href=#makepeers-labrpcclientend-me-intpersister-persister-applych-chan-applymsg aria-label="Make(peers []*labrpc.ClientEnd, me int,persister *Persister, applyCh chan ApplyMsg)">Make(peers []*labrpc.ClientEnd, me int,persister *Persister, applyCh chan ApplyMsg)</a></li><li><a href=#startcommand-interface-int-int-bool aria-label="Start(command interface{}) (int, int, bool)">Start(command interface{}) (int, int, bool)</a></li></ul></li><li><a href=#2a aria-label=2A>2A</a></li></ul></li><li><a href=#raft%e8%ae%ba%e6%96%87%e7%bf%bb%e8%af%91 aria-label=Raftè®ºæ–‡ç¿»è¯‘>Raftè®ºæ–‡ç¿»è¯‘</a><ul><li><a href=#introduction-1 aria-label=Introduction>Introduction</a></li><li><a href=#replicated-state-machine aria-label="Replicated State Machine">Replicated State Machine</a></li><li><a href=#the-raft-consensus-algorithm aria-label="The Raft consensus algorithm">The Raft consensus algorithm</a></li></ul></li><li><a href=#links aria-label=Links>Links</a></li></ul></div></details></div><div class=post-content><h2 id=lab2æ–‡æ¡£ç¿»è¯‘>Lab2æ–‡æ¡£ç¿»è¯‘<a hidden class=anchor aria-hidden=true href=#lab2æ–‡æ¡£ç¿»è¯‘>Â¶</a></h2><h3 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>Â¶</a></h3><p>è¿™æ˜¯ä¸€ç³»åˆ—å®éªŒä¸­çš„ç¬¬ä¸€ä¸ªï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ª<em>fault-tolerant key/value storage system</em>ã€‚
åœ¨æœ¬å®éªŒä¸­æˆ‘ä»¬å°†å®ç°<em>Raft(ä¸€ç§å¤åˆ¶çš„çŠ¶æ€æœºåè®®)</em>ã€‚åœ¨ä¸‹ä¸€ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬å°†åœ¨Raftä¸Šæ„å»ºä¸€ä¸ªkey/value serviceã€‚
ç„¶åï¼Œæ‚¨å°†åœ¨å¤šä¸ªå¤åˆ¶çš„çŠ¶æ€æœºä¸Šè¿›è¡Œshardæ¥æé«˜æ€§èƒ½ã€‚</p><p>å¤åˆ¶çš„æœåŠ¡é€šè¿‡åœ¨å¤šä¸ªå¤åˆ¶æœåŠ¡å™¨ä¸Šå­˜å‚¨å…¶çŠ¶æ€(å³æ•°æ®)çš„å®Œæ•´å‰¯æœ¬æ¥å®ç°<em>fault tolerance</em>ã€‚
å³ä½¿æœ‰ä¸€äº›æœåŠ¡å™¨å‡ºç°æ•…éšœ(å´©æºƒæˆ–ç½‘ç»œæ–­å¼€å’ŒæŠ–åŠ¨)replicationä¹Ÿå…è®¸å®ƒä»¬ç»§ç»­è¿è¡Œã€‚
æŒ‘æˆ˜åœ¨äº<strong>failureså¯èƒ½å¯¼è‡´å‰¯æœ¬å­˜åœ¨ä¸åŒçš„æ•°æ®</strong>ã€‚</p><p>Raftå°†å®¢æˆ·ç«¯çš„è¯·æ±‚ç»„ç»‡æˆä¸€ä¸ªåºåˆ—ï¼Œè¢«æˆä¸ºlogï¼Œå¹¶ä¸”ç¡®ä¿æ‰€æœ‰replica serversçœ‹åˆ°ç›¸åŒçš„logã€‚
æ¯ä¸ªå‰¯æœ¬æŒ‰ç…§æ—¥å¿—çš„é¡ºåºæ¥æ‰§è¡Œå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå°†å®ƒä»¬åº”ç”¨äºå…¶æœ¬åœ°çš„æœåŠ¡çŠ¶æ€å‰¯æœ¬ã€‚
ç”±äº<strong>æ‰€æœ‰å­˜æ´»çš„å‰¯æœ¬è¯»å–çš„æ—¥å¿—å†…å®¹éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥éƒ½ä»¥ç›¸åŒçš„é¡ºåºæ¥æ‰§è¡Œè¯·æ±‚ï¼Œå› æ­¤å®ƒä»¬éƒ½æœ‰ç›¸åŒçš„æœåŠ¡çŠ¶æ€</strong>ã€‚
å¦‚æœä¸€ä¸ªæœåŠ¡å™¨å¤±è´¥äº†ä½†æ˜¯åæ¥åˆæ¢å¤æ¥ï¼ŒRaftä¼šå¤åˆ¶æŠŠå®ƒçš„æ—¥å¿—æ›´æ–°ã€‚åªè¦è‡³å°‘å¤§å¤šæ•°çš„æœåŠ¡å™¨è¿˜æˆ–è€…ï¼Œå¹¶ä¸”èƒ½å¤Ÿç»§ç»­é€šä¿¡ï¼Œ
é‚£ä¹ˆRaftå°†ç»§ç»­è¿è¡Œã€‚å¦‚æœæ²¡æœ‰åˆ°è¾¾è¿™ä¸ªæ•°é‡ï¼Œé‚£ä¹ˆRaftå°†ä¼šåœæ­¢è¿è¡Œï¼Œç›´åˆ°åˆ°è¾¾è¿™ä¸ªæ•°é‡æ‰ä¼šé‡æ–°å¼€å§‹ã€‚</p><p>åœ¨æœ¬labä¸­ï¼Œä½ å°†æŠŠRaftå®ç°ä¸ºä¸€ä¸ªå¸¦æœ‰ç›¸å…³æ–¹æ³•çš„GOçš„å¯¹è±¡ç±»å‹ï¼Œç›®çš„æ˜¯ä¸ºäº†èƒ½åœ¨æ›´å¤§çš„æ¨¡å—ä¸­ä½¿ç”¨ã€‚
ä¸€ç»„Raftå®ä¾‹é€šè¿‡RPCæ¥ç»´æŠ¤replicated logsã€‚ä½ çš„Raftå®ä¾‹å°†æ”¯æŒä¸€è¿ä¸²ä¸ç¡®å®šç¼–å·(æ•°é‡?)çš„commandï¼Œ
ä¹Ÿå¯ä»¥å«log entriesã€‚ è¿™äº›entriesé€šè¿‡ç´¢å¼•æ¥è¿›è¡Œç¼–å·ã€‚å…·æœ‰ç»™å®šç´¢å¼•çš„log entryå°†è¢«æäº¤ï¼Œæ­¤æ—¶ï¼Œ
æ‚¨çš„Raftåº”è¯¥å°†è¿™ä¸ªæ¡logå‘é€åˆ°æ›´å¤§çš„æœåŠ¡ä¸Šæ‰§è¡Œã€‚</p><p>ä½ åº”è¯¥éµå¾ª <a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf target=_blank rel=noopener>extended Raft paper</a>
ä¸­è®¾è®¡ï¼Œ
ç‰¹åˆ«æ˜¯å›¾ 2.ä½ å°†å®ç°è®ºæ–‡å®çš„å¤§ éƒ¨åˆ†å†…å®¹ï¼ŒåŒ…æ‹¬<strong>ä¿å­˜æŒä¹…åŒ–çŠ¶æ€</strong>å’ŒèŠ‚<strong>ç‚¹æ•…éšœè‡ªåŠ¨é‡å¯åè¯»å–çŠ¶æ€</strong>ã€‚
ä½ å°†ä¸ä¼šå®ç°é›†ç¾¤æˆå‘˜çš„å˜åŒ–(Section 6)ã€‚</p><p>ä½ å¯èƒ½ä¼šå‘ç°è¿™ä¸ª <a href=https://thesquareplanet.com/blog/students-guide-to-raft/ target=_blank rel=noopener>æŒ‡å—</a>
å¾ˆæœ‰ç”¨ï¼Œ
è¿˜æœ‰è¿™ä¸ªå…³äºconcurrencyçš„<a href=https://pdos.csail.mit.edu/6.824/labs/raft-locking.txt target=_blank rel=noopener>é”</a>
å’Œ<a href=https://pdos.csail.mit.edu/6.824/labs/raft-structure.txt target=_blank rel=noopener>ç»“æ„</a>
çš„å»ºè®®ï¼Œ
å¦‚æœéœ€è¦æ›´å¹¿æ³›çš„è§†è§’ï¼Œå¯ä»¥çœ‹çœ‹Paxos, Chubby, Paxos Made Live, Spanner, Zookeeper, Harp, Viewstamped Replicationå’Œ
<a href=https://static.usenix.org/event/nsdi11/tech/full_papers/Bolosky.pdf target=_blank rel=noopener>Bolosky et al</a>
ã€‚</p><p>è¯·è®°ä½ï¼Œæœ¬ lab ä¸­æœ€å…·æŒ‘æˆ˜æ€§çš„éƒ¨åˆ†å¯èƒ½ä¸æ˜¯å®ç°ä½ çš„è§£å†³æ–¹æ¡ˆï¼Œè€Œæ˜¯è°ƒè¯•å®ƒã€‚ä¸ºäº†å¸®åŠ©åº”å¯¹è¿™ä¸€æŒ‘æˆ˜ï¼Œä½ å¯èƒ½éœ€è¦æŠŠäº‹ä»¶èŠ±åœ¨å¦‚ä½•ä½¿ä½ çš„å®ç°æ›´å®¹æ˜“è°ƒè¯•ã€‚
ä½ å¯ä»¥å‚è€ƒ <a href=https://pdos.csail.mit.edu/6.824/labs/guidance.html target=_blank rel=noopener>æŒ‡å¯¼é¡µ</a>
å’Œè¿™ç¯‡å…³äºæœ‰æ•ˆæ‰“å°å£°æ˜çš„
<a href=https://blog.josejg.com/debugging-pretty/ target=_blank rel=noopener>åšæ–‡</a>
ã€‚</p><p>æˆ‘ä»¬è¿˜æä¾›äº† <a href=https://pdos.csail.mit.edu/6.824/notes/raft_diagram.pdf target=_blank rel=noopener>Raft äº¤äº’å›¾</a>
ï¼Œ
å¯ä»¥å¸®åŠ©é˜æ˜Raftä»£ç å¦‚ä½•ä¸ä¸Šå±‚(ä½¿ç”¨è€…?)äº¤äº’ã€‚</p><h3 id=the-code>The code<a hidden class=anchor aria-hidden=true href=#the-code>Â¶</a></h3><p>é€šè¿‡å‘<code>raft/raft.go</code>æ·»åŠ ä»£ç æ¥å®ç°Raftã€‚åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œä½ ä¼šå‘ç°éª¨æ¶ä»£ç ï¼Œä»¥åŠå¦‚ä½•å‘é€å’Œæ¥æ”¶ RPC çš„ä¾‹å­ã€‚
ä½ çš„å®ç°å¿…é¡»æ”¯æŒä»¥ä¸‹æ¥å£ï¼Œæµ‹è¯•è€…å’Œï¼ˆæœ€ç»ˆï¼‰ä½ çš„é”®/å€¼æœåŠ¡å™¨å°†ä½¿ç”¨è¯¥æ¥å£ã€‚ä½ å¯ä»¥åœ¨<code>raft.go</code>çš„æ³¨é‡Šä¸­æ‰¾åˆ°æ›´å¤šç»†èŠ‚ã€‚</p><div class="tip custom-block"><p class=custom-block-title>TIP</p><p>raft å®ä¾‹åªèƒ½é€šè¿‡ rpc è¿›è¡Œé€šä¿¡ä¸”å¿…é¡»ä½¿ç”¨<code>labrpc</code>è¿™ä¸ªåŒ…(ä¾‹å¦‚ä¸èƒ½ä½¿ç”¨æ–‡ä»¶ä»¥åŠå…±äº«å˜é‡)ã€‚</p></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// create a new Raft server instance:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>rf</span> <span class=o>:=</span> <span class=nf>Make</span><span class=p>(</span><span class=nx>peers</span><span class=p>,</span> <span class=nx>me</span><span class=p>,</span> <span class=nx>persister</span><span class=p>,</span> <span class=nx>applyCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// start agreement on a new log entry:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>rf</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>command</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=nx>index</span><span class=p>,</span> <span class=nx>term</span><span class=p>,</span> <span class=nx>isleader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ask a Raft for its current term, and whether it thinks it is leader
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>rf</span><span class=p>.</span><span class=nf>GetState</span><span class=p>()</span> <span class=p>(</span><span class=nx>term</span><span class=p>,</span> <span class=nx>isLeader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// each time a new entry is committed to the log, each Raft peer
</span></span></span><span class=line><span class=cl><span class=c1>// should send an ApplyMsg to the service (or tester).
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ApplyMsg</span>
</span></span></code></pre></div><h4 id=makepeers-labrpcclientend-me-intpersister-persister-applych-chan-applymsg>Make(peers []*labrpc.ClientEnd, me int,persister *Persister, applyCh chan ApplyMsg)<a hidden class=anchor aria-hidden=true href=#makepeers-labrpcclientend-me-intpersister-persister-applych-chan-applymsg>Â¶</a></h4><p>ç”¨äºåˆ›å»º raft serverã€‚</p><ol><li>æ‰€æœ‰çš„ raft server çš„ç«¯å£éƒ½åœ¨<code>peers[]</code>å­˜æ”¾(åŒ…æ‹¬å½“å‰çš„æœåŠ¡)ï¼Œå½“å‰æœåŠ¡çš„ç«¯å£å¯ä»¥é€šè¿‡<code>peers[me]</code>æ¥è·å–ã€‚</li><li>æ‰€æœ‰çš„æœåŠ¡çš„<code>perrs[]</code>æ•°ç»„éƒ½å…·æœ‰ç›¸åŒçš„é¡ºåºã€‚</li><li><code>presister</code>æ˜¯ä¸€ä¸ªç”¨æ¥å­˜æ”¾<code>persistent state</code>çš„åœ°æ–¹ï¼Œå¹¶ä¸”åœ¨åˆå§‹çš„æ—¶å€™ä¼šä¿å­˜æœ€å…·çš„çŠ¶æ€ï¼Œå¦‚æœæœ‰ã€‚</li><li><code>applyCh</code>æ˜¯ service æˆ– tester å‘é€æ¶ˆæ¯ç»™ raft çš„é€šé“ã€‚<code>Make()</code>
å¿…é¡»å¿«é€Ÿè¿”å›ï¼Œæ‰€ä»¥å®ƒåº”è¯¥ä¸ºä¸€äº›é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡å¯åŠ¨<code>goruntines</code>ã€‚</li></ol><h4 id=startcommand-interface-int-int-bool>Start(command interface{}) (int, int, bool)<a hidden class=anchor aria-hidden=true href=#startcommand-interface-int-int-bool>Â¶</a></h4><p>ä½¿ç”¨Raftçš„æœåŠ¡(e.g a k/v server)å¸Œæœ›å°±ä¸‹ä¸€ä¸ªè¦è¿½åŠ åˆ°raftæ—¥å¿—çš„å‘½ä»¤è¾¾æˆä¸€è‡´(å°±æ˜¯è¿½åŠ åˆ° raft
æ—¥å¿—çš„ä¸‹ä¸€æ¡å‘½ä»¤æ˜¯ç›¸åŒçš„ï¼Ÿ)ã€‚å¦‚æœå½“å‰raft serverä¸æ˜¯leaderåˆ™è¿”å›falseã€‚
å¦åˆ™å¯åŠ¨åè®®å¹¶<strong>ç«‹å³è¿”å›</strong>ï¼Œæ— éœ€ç­‰å¾…æ—¥å¿—è¿½åŠ å®Œæˆã€‚
<strong>æ‰€ä»¥æ— æ³•ä¿è¯æ¬¡å‘½ä»¤å°†ä¸€å®šä¼šè¢«æäº¤åˆ°raftæ—¥å¿—ä¸­ï¼Œå› ä¸ºleaderå¯èƒ½ä¼šå¤±è´¥æˆ–è€…åœ¨é€‰ä¸¾ä¸­å¤±è´¥</strong>ã€‚
å³ä½¿raftå®ä¾‹è¢«killè¿™ä¸ªå‡½æ•°ä¹Ÿåº”è¯¥return gracefullyã€‚</p><p>ç¬¬ä¸€ä¸ªè¿”å›å€¼æ˜¯è¯¥å‘½ä»¤å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœå®ƒæ›¾ç»è¢«æäº¤çš„è¯ã€‚ç¬¬äºŒä¸ªè¿”å›å€¼æ˜¯å½“å‰çš„æœ¯è¯­(???)ã€‚å¦‚æœè¿™ä¸ªæœåŠ¡å™¨è®¤ä¸ºå®ƒæ˜¯é¢†å¯¼è€…ï¼Œç¬¬ä¸‰ä¸ªè¿”å›å€¼æ˜¯çœŸã€‚</p><p>æ¯ä¸ªæ–°æäº¤çš„<code>raft log entity</code>éƒ½åº”è¯¥å‘é€ä¸€ä¸ª<code>AppliMsg</code>åˆ°<code>Make()</code>çš„<code>applyCh</code>ä¸­ã€‚</p><h3 id=2a>2A<a hidden class=anchor aria-hidden=true href=#2a>Â¶</a></h3><p>å®ç°Raft leader electionä»¥åŠheartbeats(<code>AppendEntries</code>RPCsæ²¡æœ‰log entriesã€‚ç©ºçš„çš„æ„æ€?)ã€‚</p><p>2Açš„ç›®æ ‡æ˜¯: é€‰å‡ºä¸€ä¸ªleaderï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥ï¼Œå®ƒä»ç„¶æ˜¯leaderï¼Œå¦‚æœold leaderå¤±è´¥æˆ–è€…ä¸old leaderä¹‹é—´çš„æ•°æ®åŒ…å‘ç”Ÿä¸¢å¤±åˆ™ç”±new
leaderæ¥ç®¡ã€‚</p><div class="tip custom-block"><p class=custom-block-title>TIP</p><p>è¿™ä¸ªå¤±è´¥æ˜¯ leader å‡ºç°æ•…éšœçš„æ„æ€ï¼Ÿå°±æ˜¯è¯´åªè¦å®ƒæ²¡å‡ºç°è¿è¡Œæ•…éšœæˆ–è€…ç½‘ç»œé—®é¢˜å°±æ°¸è¿œæ˜¯leaderï¼Ÿ</p></div><p>è¦ç‚¹:</p><ol><li>é€šè¿‡è¿è¡Œ<code>go test -run 2A</code>æ¥è¿›è¡Œæµ‹è¯•ä½ çš„å®ç°ã€‚</li><li>æŒ‰ç…§è®ºæ–‡çš„å›¾ 2ï¼Œä¸»è¦å…³ç³»å‘é€å’Œæ¥æ”¶<code>RequestVote RPCs</code>ï¼Œä¸<code>the Rules for Servers that relate to elections</code>
ä»¥åŠ<code>the State related to leader election</code>ã€‚</li><li>æ·»åŠ å›¾ 2 ä¸­ä¸ leader election ç›¸å…³çš„çŠ¶æ€åˆ°<code>Raft</code>è¿™ä¸ªç»“æ„ä½“ä¸­ï¼Œä¸”è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªç»“æ„æ¥ä¿å­˜æ¯ä¸ªæ—¥å¿—çš„ä¿¡æ¯ã€‚</li><li>å®ç°<code>RequestVote()</code>ï¼Œè¿™æ · raft æœåŠ¡ä»¬å°±èƒ½äº’ç›¸æŠ•ç¥¨äº†ã€‚æ·»åŠ <code>RequestVOteArgs</code>å’Œ<code>RequestVoteReply</code>è€…ä¸¤ä¸ªç»“æ„ä½“ã€‚ä¿®æ”¹<code>Make()</code>
ï¼Œåˆ›å»ºä¸€ä¸ª goroutineï¼Œç”¨äºæ£€æŸ¥å¿ƒè·³æ¶ˆæ¯ï¼Œå¦‚æœæœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰æ”¶åˆ° peer çš„æ¶ˆæ¯æ—¶å°†å‘é€<code>RequestVote</code>RPCs æ¥å®šæœŸå‘èµ·é¢†å¯¼è€…é€‰ä¸¾ã€‚è¿™æ ·ï¼Œå¦‚æœæœ‰
leader äº†ï¼Œpeer å°†çŸ¥é“è°æ˜¯ leaderï¼Œæˆ–è€…è‡ªå·±æˆä¸º leaderã€‚</li><li>å®ç°å¿ƒè·³ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ª<code>AppendEntries</code>RPC ç»“æ„(å°½ç®¡ä½ å¯èƒ½è¿˜ä¸éœ€è¦æ‰€æœ‰å‚æ•°)ï¼Œ
å¹¶ä¸”è®©leaderå®šæœŸå‘é€å®ƒã€‚ç¼–å†™ä¸€ä¸ª<code>AppendEntries</code>RPC çš„ handle methodï¼Œç”¨äºé‡ç½®é€‰ä¸¾è¶…æ—¶ï¼Œ
è¿™æ ·å½“æœ‰ä¸€ä¸ªäººå·²ç»å½“é€‰æ—¶ï¼Œå…¶ä»–æœåŠ¡å™¨ä¸ä¼šåˆæˆä¸ºleaderã€‚</li><li>ç¡®ä¿ä¸åŒpeerçš„é€‰ä¸¾è¶…æ—¶ä¸åœ¨åŒä¸€æ—¶é—´å‘ç”Ÿï¼Œå¦åˆ™æ‰€æœ‰peerå°†åªä¸ºè‡ªå·±æŠ•ç¥¨ï¼Œè¿™æ ·å°±æ²¡æœ‰äººä¼šæˆä¸ºleaderäº†ã€‚</li><li>åœ¨æµ‹è¯•æ—¶ï¼Œleaderæ¯ç§’å‘é€çš„RPCè¯·æ±‚ä¸èƒ½è¶…è¿‡ 10 æ¬¡ã€‚</li><li>åœ¨æµ‹è¯•æ—¶ï¼Œè¦æ±‚raftåœ¨old leaderå¤±è´¥å5ç§’å†…é€‰ä¸¾new leader(å¦‚æœå¤§å¤šæ•°èŠ‚ç‚¹ä»ç„¶èƒ½ç»§ç»­é€šè®¯)ã€‚ä½†æ˜¯è¯·è®°ä½ï¼Œå¦‚æœå‡ºç°<code>split vote( å¦‚æœæ•°æ®åŒ…ä¸¢å¤±æˆ–è€…å€™é€‰äººé€‰æ‹©äº†ç›¸åŒçš„éšæœºé€€é¿æ—¶é—´å°±æœ‰å¯èƒ½å‘ç”Ÿ)</code>ï¼Œleaderé€‰ä¸¾å¯èƒ½éœ€è¦å¤šè½®ã€‚æ‰€ä»¥å¿…é¡»è®¾ç½®è¶³å¤ŸçŸ­çš„é€‰ä¸¾è¶…æ—¶(
ä¹Ÿå°±æ˜¯å¿ƒè·³é—´éš”)ï¼Œå³ä½¿ä¼šé€‰ä¸¾å¤šè½®ï¼Œä¹Ÿæœ‰å¯èƒ½åœ¨5ç§’å†…å®Œæˆã€‚</li><li>è®ºæ–‡çš„ç¬¬5.2èŠ‚æåˆ°çš„é€‰ä¸¾è¶…æ—¶èŒƒå›´æ˜¯150åˆ°300æ¯«ç§’ã€‚åªæœ‰å½“leaderå‘é€å¿ƒè·³çš„é¢‘ç‡å¤§å¤§é«˜äº150æ¯«ç§’ä¸€æ¬¡æ—¶ï¼Œä¸Šé¢è®ºæ–‡æåˆ°çš„èŒƒå›´æ‰æœ‰æ„ä¹‰ã€‚
ç”±äºåœ¨æµ‹è¯•æ—¶é™åˆ¶æ¯ç§’10æ¬¡å¿ƒè·³ï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨æ¯”è®ºæ–‡ä¸­æ›´å¤§çš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œä½†æ˜¯ä¸èƒ½å¤ªå¤§ï¼Œå› ä¸ºå¯èƒ½ä¼šæ— æ³•åœ¨5ç§’å†…å®Œæˆé€‰ä¸¾ã€‚</li><li>å¦‚æœæ‚¨çš„ä»£ç æ— æ³•é€šè¿‡æµ‹è¯•ï¼Œè¯·å†æ¬¡é˜…è¯»è®ºæ–‡ä¸­çš„å›¾2ï¼Œleaderé€‰ä¸¾çš„å…¨éƒ¨é€»è¾‘åˆ†å¸ƒåœ¨å›¾ä¸­å¤šä¸ªéƒ¨åˆ†ã€‚</li><li>ä¸è¦å¿˜è®°å®ç°<code>GetState()</code>ã€‚</li><li>åœ¨æµ‹è¯•æ—¶ï¼Œå¦‚æœè¦å…³é—­ä¸€ä¸ªraftå®ä¾‹ï¼Œä¼šè°ƒç”¨<code>rf.kill()</code>ã€‚æˆ‘ä»¬å¯ä»¥è°ƒç”¨<code>rf.killed</code>æ¥æ£€æŸ¥æ˜¯å¦è¢«è°ƒç”¨äº†<code>kill()</code>ã€‚æ‚¨å¯èƒ½å¸Œæœ›åœ¨æ‰€æœ‰çš„å¾ªç¯ä¸­éƒ½è¿™æ ·
åšï¼Œä»¥é¿å…æ­»äº¡çš„Raftå®ä¾‹æ‰“å°æ··ä¹±çš„ä¿¡æ¯ã€‚</li><li><code>GO RPC</code>åªå‘é€åç§°ä»¥å¤§å†™å­—æ¯å¼€å¤´çš„ç»“æ„ä½“å­—æ®µã€‚å­ç»“æ„ä½“ä¹Ÿå¿…é¡»æ‹¥æœ‰å¤§å†™çš„å­—æ®µåã€‚</li></ol><h2 id=raftè®ºæ–‡ç¿»è¯‘>Raftè®ºæ–‡ç¿»è¯‘<a hidden class=anchor aria-hidden=true href=#raftè®ºæ–‡ç¿»è¯‘>Â¶</a></h2><blockquote><p>é€‰å–ä¸€äº›é‡è¦çš„ç‰‡æ®µè¿›è¡Œç¿»è¯‘</p></blockquote><h3 id=introduction-1>Introduction<a hidden class=anchor aria-hidden=true href=#introduction-1>Â¶</a></h3><p>raftç®—æ³•å’Œå·²ç»å­˜åœ¨çš„å…±è¯†ç®—æ³•åœ¨æŸäº›åœ°æ–¹å¾ˆç›¸ä¼¼(ä¸»è¦æ˜¯Okiä»¥åŠLiskov&rsquo;sçš„Viewstamped Replication)ï¼Œä½†æ˜¯å®ƒæœ‰ä»¥ä¸‹æ–°ç‰¹æ€§:</p><blockquote><p>raft is similar in many ways to existing consensus al-gorithms (most notably, Oki and Liskovâ€™s Viewstamped
Replication), but it has several novel features:</p></blockquote><ul><li>å¼ºé¢†å¯¼è€…: Raftä½¿ç”¨ä¸€ç§æ¯”å…¶ä»–å…±è¯†ç®—æ³•æ›´å¼ºçš„é¢†å¯¼å½¢å¼ã€‚ä¾‹å¦‚ï¼Œæ—¥å¿—åªä»leaderå‘é€ç»™å…¶ä»–æœåŠ¡å™¨ã€‚è¿™ç®€åŒ–äº†å¯¹å¤åˆ¶æ—¥å¿—çš„ç®¡ç†ï¼Œä½¿çš„Raftæ›´å®¹æ˜“ç†è§£ã€‚</li><li>é¢†å¯¼é€‰ä¸¾: Raftä½¿ç”¨éšæœºå®šæ—¶å™¨æ¥é€‰å–leaderã€‚è¿™ç§æ–¹å¼ä»…ä»…æ˜¯åœ¨æ‰€æœ‰å…±è¯†ç®—æ³•éƒ½éœ€è¦æ”¹è¿›çš„å¿ƒè·³æœºåˆ¶ä¸Šæœ‰äº›è®¸æ”¹è¿›ï¼Œç„¶è€Œè¿™ä½¿å¾—Raftåœ¨è§£å†³å†²çªæ—¶æ›´ç®€å•å’Œå¿«é€Ÿã€‚</li><li>æˆå‘˜è°ƒæ•´: é›†ç¾¤ä¸­æ›´æ”¹serveræ—¶ï¼ŒRaftä½¿ç”¨äº†æ–°çš„è”åˆå…±è¯†(join consensus)ç®—æ³•ï¼Œ
ä¸¤ç§ä¸åŒçš„é…ç½®çš„majoritiesåœ¨å˜æ›´æœŸé—´é‡å (overlap)ï¼Œ å…è®¸é›†ç¾¤åœ¨é…ç½®å˜æ›´çš„æ—¶å€™ï¼ŒæŒç»­æ­£å¸¸è¿è¡Œã€‚</li></ul><blockquote><ul><li>Strong leader: Raft uses a stronger form of leadership than other consensus algorithms. For example,log entries
only flow from the leader to other servers. This simplifies the management of the replicated log and makes Raft
easier to understand.</li><li>Leader election: Raft uses randomized timers to elect leaders. This adds only a small amount of mechanism to the
heartbeats already required for any consensus algorithm, while resolving conflicts simply and rapidly.</li><li>Membership changes: Raftâ€™s mechanism for changing the set of servers in the cluster uses a new joint consensus
approach where the majorities of two different configurations overlap during transitions. This allows the cluster
to continue operating normally during configuration changes.</li></ul></blockquote><h3 id=replicated-state-machine>Replicated State Machine<a hidden class=anchor aria-hidden=true href=#replicated-state-machine>Â¶</a></h3><p><code>å¤åˆ¶çŠ¶æ€æœº(Replicated State Machine)</code>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¢«ç”¨äºè§£å†³å„ç§å®¹é”™é—®é¢˜ã€‚ä¾‹å¦‚GFS,HDFS,RAMCloudç­‰å•leaderçš„å¤§å‹é›†ç¾¤ç³»ç»Ÿï¼Œé€šå¸¸ä½¿ç”¨ç‹¬ç«‹
çš„å¤åˆ¶çŠ¶æ€æœºæ¥ç®¡ç†é¢†å¯¼é€‰ä¸¾å’Œå­˜å‚¨é…ç½®ä¿¡æ¯æ¥ä¿è¯åœ¨leaderå´©æºƒä¼šå­˜æ´»ä¸‹æ¥ï¼Œå¤åˆ¶çŠ¶æ€æœºçš„ä¾‹å­åŒ…æ‹¬Chubbyä»¥åŠZookeeperã€‚</p><p><figure class=align-center><img src=/images/7.png alt="Figure 1: å¤åˆ¶çŠ¶æ€æœºæ¶æ„ã€‚å…±è¯†ç®—æ³•ç®¡ç†æ¥è‡ªå®¢æˆ·ç«¯çš„åŒ…å«çŠ¶æ€æœºå‘½ä»¤çš„å¤åˆ¶æ—¥å¿—ï¼ŒçŠ¶æ€æœºæŒ‰ç…§ç›¸åŒçš„é¡ºåºæ¥å¤„ç†å®ƒä»¬ï¼Œæ‰€ä»¥å®ƒä»¬äº§ç”Ÿç›¸åŒçš„è¾“å‡ºã€‚"><figcaption>Figure 1: å¤åˆ¶çŠ¶æ€æœºæ¶æ„ã€‚å…±è¯†ç®—æ³•ç®¡ç†æ¥è‡ªå®¢æˆ·ç«¯çš„åŒ…å«çŠ¶æ€æœºå‘½ä»¤çš„å¤åˆ¶æ—¥å¿—ï¼ŒçŠ¶æ€æœºæŒ‰ç…§ç›¸åŒçš„é¡ºåºæ¥å¤„ç†å®ƒä»¬ï¼Œæ‰€ä»¥å®ƒä»¬äº§ç”Ÿç›¸åŒçš„è¾“å‡ºã€‚</figcaption></figure></p><p>å…±è¯†ç®—æ³•é€šå¸¸å‡ºç°åœ¨å¤åˆ¶çŠ¶æ€æœºçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œåœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œåœ¨ä¸€ç»„serverä¸Šçš„çŠ¶æ€æœºå¯¹åŒä¸€ä¸ªçš„çŠ¶æ€ä¼šè®¡ç®—å‡ºç›¸åŒçš„å‰¯æœ¬ï¼Œå³ä½¿ä¸€äº›serverå®•æœºä¹Ÿå¯ä»¥ç»§ç»­è¿è¡Œã€‚</p><blockquote><p>Replicated state machines are used to solve a variety of fault tolerance problems in distributed systems. For example,
large-scale systems that have a single cluster leader, such as GFS, HDFS, and RAMCloud, typically use a separate
replicated state machine to manage leader election and store configuration information that must survive leader
crashes. Examples of replicated state machines include Chubby and ZooKeeper. Consensus algorithms typically arise in
the context of replicated state machines.In this approach, state machines on a collection of servers compute identical
copies of the same state and can continue operating even if some of the servers are down.</p></blockquote><p>å¤åˆ¶çŠ¶æ€æœºé€šè¿‡<strong>å¤åˆ¶æ—¥å¿—å®ç°</strong>ï¼Œå¦‚å›¾ä¸€æ‰€ç¤ºã€‚æ¯ä¸ªæœåŠ¡ä¿å­˜åŒ…å«ä¸€ç³»åˆ—å‘½ä»¤çš„æ—¥å¿—ï¼Œå…¶çŠ¶æ€æœºæŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œå®ƒä»¬ã€‚
æ¯ä¸ª<strong>æ—¥å¿—åŒ…å«ç›¸åŒé¡ºåºçš„ç›¸åŒå‘½ä»¤</strong>ï¼Œæ‰€ä»¥æ¯ä¸ªçŠ¶æ€æœºå¤„ç†ç›¸åŒçš„å‘½ä»¤åºåˆ—ã€‚å› ä¸º<strong>çŠ¶æ€æœºæ˜¯ç¡®å®šçš„</strong>ï¼Œ
æ‰€ä»¥æ¯ä¸ªçŠ¶æ€æœº<strong>ä¼šè®¡ç®—å‡ºç›¸åŒçš„çŠ¶æ€</strong>å’Œ<strong>ç›¸åŒé¡ºåºçš„è¾“å‡º</strong>ã€‚</p><blockquote><p>Replicated state machines are typically implemented using a replicated log, as shown in Figure 1. Each server stores a
log containing a series of commands, which its state machine executes in order. Each log contains the same commands in
the same order, so each state machine processes the same sequence of commands. Since the state machines are
deterministic, each computes the same state and the same sequence of outputs.</p></blockquote><p>å…±è¯†ç®—æ³•çš„ä»»åŠ¡æ˜¯<strong>ä¿è¯å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§</strong>ã€‚æœåŠ¡å™¨ä¸Šçš„å…±è¯†æ¨¡å—æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤å¹¶æŠŠå®ƒä»¬æ·»åŠ åˆ°æ—¥å¿—ä¸­ï¼Œ
å¹¶ä¸å…¶ä»–æœåŠ¡å™¨ä¸Šçš„å…±è¯†æ¨¡å—è¿›è¡Œé€šè®¯ä»¥ç¡®ä¿å®ƒä»¬çš„æ¯ä¸€æ¡æ—¥å¿—æœ€ç»ˆéƒ½ç›¸åŒ(ç›¸åŒçš„è¯·æ±‚æœ‰ç›¸åŒçš„é¡ºåº)ï¼Œ å³ä½¿æœ‰ä¸€äº›æœåŠ¡å¤±è´¥äº†ã€‚ä¸€æ—¦å‘½ä»¤è¢«æ­£ç¡®çš„å¤åˆ¶ï¼Œ
æ¯ä¸€ä¸ªæœåŠ¡çš„çŠ¶æ€æœºä¼šæŒ‰ç…§æ—¥å¿—çš„é¡ºåºå»å¤„ç†å®ƒä»¬ï¼Œç„¶åå°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>å› æ­¤ï¼Œè¿™äº›æœåŠ¡ä¼¼ä¹æˆä¸ºäº†ä¸€ä¸ªå•ä¸€çš„ï¼Œé«˜åº¦å¯é çš„çŠ¶æ€æœºã€‚</p><blockquote><p>Keeping the replicated log consistent is the job of the consensus algorithm. The consensus module on a server receives
commands from clients and adds them to its log. It communicates with the consensus modules on other servers to ensure
that every log eventually contains the same requests in the same order, even if some servers fail. Once commands are
properly replicated, each serverâ€™s state machine processes them in log order, and the outputs are returned to clients.
As a result, the servers appear to form a single, highly reliable state machine.</p></blockquote><p>åœ¨å®é™…çš„å…±è¯†ç®—æ³•é€šå¸¸æœ‰ä»¥ä¸‹å±æ€§:</p><ul><li>ç¡®ä¿éæ‹œå åº­(non-Byzantine)æ¡ä»¶ä¸‹çš„<em>å®‰å…¨æ€§</em>(æ°¸è¿œä¸è¿”å›é”™è¯¯çš„ç»“æœ)ï¼ŒåŒ…æ‹¬ç½‘ç»œå»¶è¿Ÿï¼Œåˆ†åŒºä»¥åŠç½‘ç»œæ•°æ®åŒ…ä¸¢å¤±ã€å†—ä½™ã€ä¹±åºã€‚</li><li>åªè¦å¤§å¤šæ•°çš„æœåŠ¡éƒ½åœ¨è¿è¡Œå¹¶èƒ½ç›¸äº’é€šä¿¡ä¸”å’Œå®¢æˆ·ç«¯é€šä¿¡ï¼Œå®ƒä»¬å°±èƒ½å‘æŒ¥å‡ºå…¨éƒ¨çš„åŠŸèƒ½(<em>å¯ç”¨æ€§</em>)ã€‚å› æ­¤ï¼Œä¸€ä¸ª5å°æœåŠ¡çš„é›†ç¾¤èƒ½å®¹å¿2å°æœåŠ¡å‡ºç°æ•…éšœã€‚
å‡å®šæœåŠ¡åº”ä¸ºåœæœºè€Œå‡ºç°æ•…éšœï¼Œå®ƒä»¬å¯èƒ½ç¨åä¼šä»stable storage`ä¸­æ¢å¤çŠ¶æ€å¹¶ä»æ–°åŠ å…¥é›†ç¾¤ã€‚</li><li>ä¸ä¾èµ–ä¸timingæ¥ä¿è¯æ—¥å¿—çš„ä¸€è‡´æ€§: é”™è¯¯çš„æ—¶é’Ÿå’Œæç«¯çš„ä¿¡æ¯å»¶è¿Ÿå»¶è¿Ÿåœ¨æœ€åçš„æƒ…å†µä¸‹ä¼šå¯¼è‡´å¯ç”¨æ€§é—®é¢˜ã€‚</li><li>åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå‘½ä»¤çš„å®Œæˆåœ¨äºé›†ç¾¤ä¸­çš„å¤§å¤šæ•°å¯¹å•è½®è¿œç¨‹è°ƒç”¨ä½œå‡ºå“åº”ï¼Œå°‘æ•°ä½æ°´å¹³çš„æœåŠ¡ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚</li></ul><blockquote><p>Consensus algorithms for practical systems typically have the following properties:</p><ul><li>They ensure <em>safety</em> (never returning an incorrect result) under all non-Byzantine conditions,
including network delays, partitions, and packet loss, duplication, and reordering.</li><li>They are fully functional (<em>available</em>) as long as any
majority of the servers are operational and can communicate with each other and with clients. Thus, a
typical cluster of five servers can tolerate the failure of any two servers. Servers are assumed to fail by
stopping; they may later recover from state on stable storage and rejoin the cluster.</li><li>They do not depend on timing to ensure the consistency of the logs: faulty clocks and extreme message
delays can, at worst, cause availability problems.</li><li>In the common case, a command can complete as soon as a majority of the cluster has responded to a single round of
remote procedure calls; a minority of low servers need not impact overall system performance.</li></ul></blockquote><h3 id=the-raft-consensus-algorithm>The Raft consensus algorithm<a hidden class=anchor aria-hidden=true href=#the-raft-consensus-algorithm>Â¶</a></h3><p>Raftå°±æ˜¯ç”¨äºç®¡ç†ä¸Šä¸€è§£æè¿°çš„å¤åˆ¶æ—¥å¿—çš„ç®—æ³•ã€‚å›¾2æ˜¯å¯¹è¯¥ç®—æ³•çš„ç²¾ç®€å‹å¼çš„æ€»ç»“ï¼Œå›¾3åˆ—å‡ºæ¥è¯¥ç®—æ³•çš„å…³é”®å±æ€§ï¼Œæ¥ä¸‹æ¥å¯¹è¿™äº›éƒ¨åˆ†è¿›è¡Œé€ä¸€è®¨è®ºã€‚</p><blockquote><p>Raft is an algorithm for managing a replicated log of he form described in Section 2. Figure 2 summarizes the
algorithm in condensed form for reference, and Figure 3 lists key properties of the algorithm; the elements of these
figures are discussed piecewise over the rest of this section.</p></blockquote><p>// todo</p><blockquote><p>Raft implements consensus by first electing a distinguished leader, then giving the leader complete responsibility for
managing the replicated log. The leader accepts log entries from clients, replicates them on other servers, and tells
servers when it is safe to apply log entries to their state machines. Having a leader simplifies the management of the
replicated log. For example, the leader can decide where to place new entries in the log without consulting other
servers, and data flows in a simple fashion from the leader to other servers. A leader can fail or become disconnected
from the other servers, in which casea new leader is elected.</p></blockquote><p><figure class=align-center><img src=/images/raftp2.png alt="Figure 2: Raftå…±è¯†ç®—æ³•çš„ç²¾ç®€æ‘˜è¦(ä¸åŒ…æ‹¬æˆå‘˜æ›´æ”¹ä»¥åŠæ—¥å¿—å‹ç¼©)ã€‚å·¦ä¸Šè§’çš„æœåŠ¡å™¨è¡Œä¸ºè¢«æè¿°ä¸ºä¸€ç»„ç‹¬ç«‹ä¸”é‡å¤è§¦å‘çš„è§„åˆ™ã€‚"><figcaption>Figure 2: Raftå…±è¯†ç®—æ³•çš„ç²¾ç®€æ‘˜è¦(ä¸åŒ…æ‹¬æˆå‘˜æ›´æ”¹ä»¥åŠæ—¥å¿—å‹ç¼©)ã€‚å·¦ä¸Šè§’çš„æœåŠ¡å™¨è¡Œä¸ºè¢«æè¿°ä¸ºä¸€ç»„ç‹¬ç«‹ä¸”é‡å¤è§¦å‘çš„è§„åˆ™ã€‚</figcaption></figure></p><p><figure class=align-center><img src=/images/f3.png alt="Figure 3: Raftä¿è¯è¿™äº›å±æ€§åœ¨åœ¨ä»»ä½•æ—¶å€™éƒ½ä¸Šæ­£ç¡®çš„ã€‚"><figcaption>Figure 3: Raftä¿è¯è¿™äº›å±æ€§åœ¨åœ¨ä»»ä½•æ—¶å€™éƒ½ä¸Šæ­£ç¡®çš„ã€‚</figcaption></figure></p><blockquote><p>Raft is an algorithm for managing a replicated log of the form described in Section 2. Figure 2 summarizes the
algorithm in condensed form for reference, and Figure 3 lists key properties of the algorithm; the elements of these
figures are discussed piecewise over the rest of this section</p></blockquote><h2 id=links>Links<a hidden class=anchor aria-hidden=true href=#links>Â¶</a></h2><ol><li>é¡¹ç›®åœ°å€: <a href=https://pdos.csail.mit.edu/6.824/labs/lab-raft.html target=_blank rel=noopener>https://pdos.csail.mit.edu/6.824/labs/lab-raft.html</a></li><li>GFS ç›¸å…³èµ„æ–™: <a href=https://fzdwx.github.io/posts/2022-10-07-gfs/#links target=_blank rel=noopener>https://fzdwx.github.io/posts/2022-10-07-gfs/#links</a></li><li>Raft paper: <a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf target=_blank rel=noopener>https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf</a></li><li>Diagram of Raft interactionsï¼š <a href=https://pdos.csail.mit.edu/6.824/notes/raft_diagram.pdf target=_blank rel=noopener>https://pdos.csail.mit.edu/6.824/notes/raft_diagram.pdf</a></li><li>Students guid to Raft: <a href=https://thesquareplanet.com/blog/students-guide-to-raft/ target=_blank rel=noopener>https://thesquareplanet.com/blog/students-guide-to-raft/</a></li><li>Raft locking: <a href=https://pdos.csail.mit.edu/6.824/labs/raft-locking.txt target=_blank rel=noopener>https://pdos.csail.mit.edu/6.824/labs/raft-locking.txt</a></li><li>Raft structure: <a href=https://pdos.csail.mit.edu/6.824/labs/raft-structure.txt target=_blank rel=noopener>https://pdos.csail.mit.edu/6.824/labs/raft-structure.txt</a></li><li>Paxos Replicated State Machines as the Basis of a High-Performance Data
Store <a href=https://static.usenix.org/event/nsdi11/tech/full_papers/Bolosky.pdf target=_blank rel=noopener>https://static.usenix.org/event/nsdi11/tech/full_papers/Bolosky.pdf</a></li><li><a href=https://www.cnblogs.com/niejunlei/p/9719557.html target=_blank rel=noopener>https://www.cnblogs.com/niejunlei/p/9719557.html</a></li><li><a href=https://blog.csdn.net/viskaz/article/details/124232474 target=_blank rel=noopener>https://blog.csdn.net/viskaz/article/details/124232474</a></li><li><a href=https://www.cnblogs.com/brianleelxt/p/13251540.html target=_blank rel=noopener>https://www.cnblogs.com/brianleelxt/p/13251540.html</a></li></ol></div><footer class=post-footer><nav class=paginav><a class=prev href=https://fzdwx.github.io/posts/2022-10-10-code-alias/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>Code:alias</span></a>
<a class=next href=https://fzdwx.github.io/posts/2022-10-09-mario-nes/><span class=title>Next Page&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>åœ¨Abstract Machineä¸Šç©è¶…çº§é©¬é‡Œå¥¥</span></a></nav></footer></article></main><footer class=footer><span>Copyright <a href=https://github.com/fzdwx target=_blank rel=noopener>fzdwx</a>
since 2022</span></span>
<span><a target=_blank href=https://github.com/fzdwx/fzdwx.github.io/issues>æ¬¢è¿äº¤æµ</a></span></footer><script>lucide.createIcons()</script><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n="1"=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a="1"=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script><script>mediumZoom(".entry-cover img"),mediumZoom(".post-content img:not([no-zoom])")</script><script src=/js/instantclick.min.js data-no-instant></script>
<script data-no-instant>InstantClick.init()</script></body></html>